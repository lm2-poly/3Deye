

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Accounting for perspective &mdash; 3Drecons 1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Using the GUI" href="gui.html" />
    <link rel="prev" title="Without perspective" href="nopersp.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> 3Drecons
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">User guide:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../user_guide.html">3D trajectory reconstruction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="shot_detect.html">Shot detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="nopersp.html">Without perspective</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Accounting for perspective</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#trajectory-reconstruction">Trajectory reconstruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#position-optimisation">Position optimisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-indicators">Error indicators</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gui.html">Using the GUI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html#calibration">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html#post-processing">Post-processing</a></li>
</ul>
<p class="caption"><span class="caption-text">Functions:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../function_list.html">Camera object</a></li>
<li class="toctree-l1"><a class="reference internal" href="../function_list.html#module-calibration.main">Camera calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../function_list.html#module-data_treat.reconstruction_3d">3D Trajectory reconstruction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../function_list.html#module-data_treat.data_pp">Trajectory post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../function_list.html#module-data_treat.make_report">Report generation and save</a></li>
<li class="toctree-l1"><a class="reference internal" href="../function_list.html#module-gui.recons_gui">GUI fonctions</a></li>
</ul>
<p class="caption"><span class="caption-text">Credits:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Credits</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">3Drecons</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../user_guide.html">3D trajectory reconstruction</a> &raquo;</li>
        
      <li>Accounting for perspective</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/contents/3d_recons/persp.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="accounting-for-perspective">
<h1>Accounting for perspective<a class="headerlink" href="#accounting-for-perspective" title="Permalink to this headline">¶</a></h1>
<div class="section" id="trajectory-reconstruction">
<h2>Trajectory reconstruction<a class="headerlink" href="#trajectory-reconstruction" title="Permalink to this headline">¶</a></h2>
<p>Perspective is accounted for by using the common pinhole camera model (see the <a class="reference external" href="https://docs.opencv.org/2.4/doc/tutorials/calib3d/camera_calibration/camera_calibration.html">opencv documentation</a>
for more detail)</p>
<p>First, a camera calibration must be performed for each camera to obtain both the camera intrinsic matrix <span class="math notranslate nohighlight">\(F\)</span> and the transformation matrix between the camera coordinate system and the sample’s coordinate system (CS) <span class="math notranslate nohighlight">\(M\)</span></p>
<p>For each camera, the shot 3D coordinates in the sample CS are therefore related by the following relation:</p>
<p><span class="math notranslate nohighlight">\(\begin{bmatrix} s_1 u_1 \\ s_1 v_1 \\ s_1 \end{bmatrix} = F_1 \cdot M_1 \cdot \begin{bmatrix} X \\ Y \\ Z \\ 1 \end{bmatrix},\)</span></p>
<p><span class="math notranslate nohighlight">\(\begin{bmatrix} s_2 u_2 \\ s_2 v_2 \\ s_2 \end{bmatrix} = F_2 \cdot M_2 \cdot \begin{bmatrix} X \\ Y \\ Z \\ 1 \end{bmatrix},\)</span></p>
<p>for camera 1 and 2 respectively.</p>
<p>The two equations above can therefore be re-written as a linear system with 4 equations for our three unknowns (X,Y and Z).</p>
<img alt="../../_images/persp_redon.png" class="align-center" src="../../_images/persp_redon.png" />
<p>As can be seen in the figure, the two cameras sees approximately the same information toward the x (u1 and v2 coordinates on each camera) coordinate of the shots, one of the above equation can be ignored to obtain a simple linear system with 3 equations and three unknowns</p>
<p>The function <a class="reference internal" href="../function_list.html#data_treat.reconstruction_3d.get_3d_coor" title="data_treat.reconstruction_3d.get_3d_coor"><code class="xref py py-func docutils literal notranslate"><span class="pre">data_treat.reconstruction_3d.get_3d_coor()</span></code></a> reconstructs the shot 3D trajectory with this method, assuming that the shot position on each camera and the cameras intrinsic and transformation matrices were already obtained.</p>
<dl class="py function">
<dt id="data_treat.reconstruction_3d.get_3d_coor">
<code class="sig-prename descclassname">data_treat.reconstruction_3d.</code><code class="sig-name descname">get_3d_coor</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">minspan_len</span></em>, <em class="sig-param"><span class="n">traj_2d_left</span></em>, <em class="sig-param"><span class="n">traj_2d_top</span></em>, <em class="sig-param"><span class="n">cam_left</span></em>, <em class="sig-param"><span class="n">cam_top</span></em>, <em class="sig-param"><span class="n">method</span><span class="o">=</span><span class="default_value">'persp'</span></em>, <em class="sig-param"><span class="n">timespan</span><span class="o">=</span><span class="default_value">[]</span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/data_treat/reconstruction_3d.html#get_3d_coor"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#data_treat.reconstruction_3d.get_3d_coor" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieve the shot 3D trajectory from each cameras parameters and 2D trajectories</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>minspan_len</strong> – number of time points</p></li>
<li><p><strong>traj_2d_left</strong> – trajectory found by the left camera</p></li>
<li><p><strong>traj_2d_top</strong> – trajectory found by the right camera</p></li>
<li><p><strong>cam_top</strong><strong>,</strong><strong>cam_left</strong> – camera object for the top and left camera</p></li>
<li><p><strong>method</strong> – “persp” (default) or “persp-opti” - use analytical expression or least square optimisation</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p></p>
</dd>
</dl>
</dd></dl>

<p>Using the method “persp”, the function only builds the linear system, ignoring on of the four equations and inverts it to get the shot 3D trajectory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Usage of high frequency camera often requires to reduce the acquisition resolution to reduce the acquisition time. Since the camera intrinsic and transformation matrices relates the 3D coordinates to the pixel on the screen, the detected coordinates on each screen have to be expressed in the unresized screen frame. This is performed by the function <code class="xref py py-func docutils literal notranslate"><span class="pre">data_treat.reonstruction_3d.cam_shift_resize()</span></code> which is called automatically in the function <code class="xref py py-func docutils literal notranslate"><span class="pre">data_treat.reonstruction_3d.reconstruct_3d()</span></code>. The coordinate shift is performed knowing the camera initial and resized resolution provided in the camera objects.</p>
</div>
</div>
<div class="section" id="position-optimisation">
<h2>Position optimisation<a class="headerlink" href="#position-optimisation" title="Permalink to this headline">¶</a></h2>
<p>Slight time delay between the pictures taken by the two cameras can lead to errors in the trajectory estimation as the trajectory will be guessed using two pictures taken at different moments.</p>
<p>To reduce this error, the trajectory of one of the two camera is linearly interpolated to get the pixel coordinate of the shots on the two cameras at the same time.
However, the time delay between the two cameras is difficult to caracterize experimentally. The ‘persp-opti’ mode of 3D eye finds the values of the camera delay that minimizes the overall projection errors on the two cameras using scipy differential_evolution optimization (see figure below).</p>
<img alt="../../_images/persp-opti.png" class="align-center" src="../../_images/persp-opti.png" />
<p>Shot detection and 3D trajectory reconstruction using this method can be performed by calling the function <code class="xref py py-func docutils literal notranslate"><span class="pre">data_treat.reonstruction_3d.reconstruct_3d()</span></code> with the method attribute set to ‘persp’ or ‘persp-opti’.</p>
</div>
<div class="section" id="error-indicators">
<h2>Error indicators<a class="headerlink" href="#error-indicators" title="Permalink to this headline">¶</a></h2>
<p>In addition to being more accurate than the <cite>no-persp</cite> method, the <cite>persp</cite> and <cite>persp-opti</cite> method provides errors indicators on the recovered shot 3D coordinates.
The reprojection error consist in projecting the shot (X,Y,Z) coordinates on each camera and compare it to the initially detected shot position on the screen.
The reprojection is simply performed using the equations above for each camera.</p>
<img alt="../../_images/reprojection_error.png" class="align-center" src="../../_images/reprojection_error.png" />
<p>The figure above provides an exemple of such reprojection error plot in an ideal case of a perfect camera system modeled in <a class="reference external" href="https://www.blender.org/">blender</a> 3D software.</p>
<style> .blue {color:#3483bbff; font-weight:bold; font-size:16px} </style>
    <style> .orange {color:#ff7f0eff; font-weight:bold; font-size:16px} </style><p>A bad match between the <span class="orange">projected points</span> and the <span class="blue">detected points</span> could result from:</p>
<p>1. a bad calibration of either the intrinsic or the transformation matrix: This problem could be solved by taking more chessboard pictures with more various positions, while ensuring the picture quality (see for instance <a class="reference external" href="https://www.photomodeler.com/kb/taking_proper_images_for_camera_calibrat/">this link</a> for advices on camera calibration).</p>
<p>2. a bad detection of the shot position on one of the cameras: this could be solved by playing with the shot detection threshold, by using a more sophisticated feature detection algorithm (see for instance <a class="reference external" href="https://docs.opencv.org/3.4/db/d27/tutorial_py_table_of_contents_feature2d.html">the opencv documentation</a>) or by improving the picture contrast.</p>
<p>It should be noted that this indicator mostly indicates wether the method was well applied or not but not wether the method is relevent for the studied situation.</p>
<p>Reprojection error can be plotted using the <a class="reference internal" href="../function_list.html#data_treat.reconstruction_3d.plot_proj_error" title="data_treat.reconstruction_3d.plot_proj_error"><code class="xref py py-func docutils literal notranslate"><span class="pre">data_treat.reconstruction_3d.plot_proj_error()</span></code></a> function.</p>
<dl class="py function">
<dt id="data_treat.reconstruction_3d.plot_proj_error">
<code class="sig-prename descclassname">data_treat.reconstruction_3d.</code><code class="sig-name descname">plot_proj_error</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">traj_top</span></em>, <em class="sig-param"><span class="n">traj_left</span></em>, <em class="sig-param"><span class="n">X</span></em>, <em class="sig-param"><span class="n">Y</span></em>, <em class="sig-param"><span class="n">Z</span></em>, <em class="sig-param"><span class="n">cam_top</span></em>, <em class="sig-param"><span class="n">cam_left</span></em>, <em class="sig-param"><span class="n">time</span></em>, <em class="sig-param"><span class="n">savedir</span><span class="o">=</span><span class="default_value">'data_treat/Reproj_error.png'</span></em>, <em class="sig-param"><span class="n">plot</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/data_treat/reconstruction_3d.html#plot_proj_error"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#data_treat.reconstruction_3d.plot_proj_error" title="Permalink to this definition">¶</a></dt>
<dd><p>Plot the reprojected trajectory for each camera to check for the trajectory errors</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>traj_top</strong><strong>,</strong><strong>traj_left</strong> – screen trajectory for the top and left cameras</p></li>
<li><p><strong>X</strong><strong>,</strong><strong>Y</strong><strong>,</strong><strong>Z</strong> – computed 3D trajectory</p></li>
<li><p><strong>cam_top</strong><strong>,</strong><strong>cam_left</strong> – top and left camera objects</p></li>
<li><p><strong>savedir</strong> – path to the directory to save the reprojection error to</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p>The error will also be plotted when calling <a class="reference internal" href="../function_list.html#data_treat.reconstruction_3d.reconstruct_3d" title="data_treat.reconstruction_3d.reconstruct_3d"><code class="xref py py-func docutils literal notranslate"><span class="pre">data_treat.reconstruction_3d.reconstruct_3d()</span></code></a> with the argument <cite>plot</cite> set to <cite>True</cite>.</p>
<p>If the <strong>pixel to centimeter</strong> ratio <span class="math notranslate nohighlight">\(\delta\)</span> is provided in the camera object (or in the respective input of the GUI), an uncertainty on the 3D position estimation will also be provided based on the reprojection error, computed as:</p>
<p><span class="math notranslate nohighlight">\(\sqrt{(x_{proj} - x_{detect})^2 + (y_{proj} - y_{detect})^2)} * \delta,\)</span></p>
<p>where <span class="math notranslate nohighlight">\((x,y)_{proj}\)</span> and <span class="math notranslate nohighlight">\((x,y)_{detect}\)</span> are respectively the reprojected and detected shot coordinate on the 2D screen.</p>
<p>..note: This estimation is neither a lower nor a higher boundary of the effective position error but provides an order of accuracy.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gui.html" class="btn btn-neutral float-right" title="Using the GUI" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="nopersp.html" class="btn btn-neutral float-left" title="Without perspective" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, S.Breumier

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>